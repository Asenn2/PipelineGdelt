services:
  # --- 1. STOCKAGE (Data Lake) ---
  minio:
    image: minio/minio
    container_name: minio
    ports:
      - "9000:9000" # API S3
      - "9001:9001" # Console Web
    environment:
      - MINIO_ROOT_USER=minioadmin
      - MINIO_ROOT_PASSWORD=minioadmin
    command: server /data --console-address ":9001"
    volumes:
      - ./minio_data:/data
    networks:
      - gdelt-net
    deploy:
      resources:
        limits:
          memory: 512M # <--- Suffisant pour un usage local
  # --- 2. INGESTION (ETL 1) ---
  nifi:
    image: apache/nifi:latest
    container_name: nifi
    ports:
      - "8443:8443"
    volumes:
      - ./nifi_conf:/opt/nifi/nifi-current/conf
    environment:
      - NIFI_WEB_HTTP_PORT=
      - NIFI_WEB_HTTPS_PORT=8443
      - SINGLE_USER_CREDENTIALS_USERNAME=admin
      - SINGLE_USER_CREDENTIALS_PASSWORD=admin12345678
      - NIFI_JVM_HEAP_INIT=512m # DÃ©marre petit
      - NIFI_JVM_HEAP_MAX=1024m # Max 1 Go (Suffisant pour GDELT)
    depends_on:
      - minio
    networks:
      - gdelt-net
    deploy:
      resources:
        limits:
          memory: 1536M # On laisse une marge de 500Mo au-dessus du Heap Java pour l'OS
  # --- 3. TRAITEMENT (Spark Cluster) ---
  spark:
    image: bitnamilegacy/spark:3.5
    container_name: spark
    user: root # Important pour Ã©viter les soucis de permission dans le conteneur unique
    environment:
      # On ne lance pas de daemon Master/Worker spÃ©cifique, juste un conteneur prÃªt Ã  bosser
      - SPARK_RPC_AUTHENTICATION_ENABLED=no
      - SPARK_RPC_ENCRYPTION_ENABLED=no
      - SPARK_LOCAL_STORAGE_ENCRYPTION_ENABLED=no
      - SPARK_SSL_ENABLED=no
      - SPARK_DRIVER_MEMORY=1G
      - SPARK_DAEMON_MEMORY=512m
      - SPARK_DRIVER_BIND_ADDRESS=0.0.0.0
      - SPARK_DRIVER_HOST=127.0.0.1
      - SPARK_LOCAL_IP=127.0.0.1
    ports:
      - "8080:8080" # UI Spark (pour voir tes jobs)
      - "4040:4040" # UI du Job en cours
    volumes:
      - ./scripts:/app/scripts
      - ./spark_ivy_cache:/root/.ivy2
    command: /bin/bash /app/scripts/start_pipelines.sh
    networks:
      - gdelt-net
    deploy:
      resources:
        limits:
          memory: 2G # 1G Driver + Overhead Java + OS
  # --- 4. WAREHOUSE (Base de donnÃ©es) ---
  clickhouse:
    image: clickhouse/clickhouse-server
    container_name: clickhouse
    ports:
      - "8123:8123" # HTTP Port
    volumes:
      - ./clickhouse_data:/var/lib/clickhouse
    environment:
      - CLICKHOUSE_DB=default
      - CLICKHOUSE_USER=default
      - CLICKHOUSE_PASSWORD=1234  # <--- ON FORCE LE MOT DE PASSE ICI
      - CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT=1
    ulimits:
      nofile:
        soft: 262144
        hard: 262144
    networks:
      - gdelt-net
    deploy:
      resources:
        limits:
          memory: 3G # Suffisant pour tes requÃªtes GDELT actuelles
  # --- 5. VISUALISATION ---
  grafana:
    image: grafana/grafana
    container_name: grafana
    ports:
      - "3000:3000"
    environment:
      - GF_PLUGINS_ALLOW_LOADING_UNSIGNED_PLUGINS=grafana-clickhouse-datasource
    volumes:
      # ðŸ‘‡ On monte le dossier qu'on vient de remplir
      - ./grafana_data:/var/lib/grafana
      - ./grafana_plugins:/var/lib/grafana/plugins  
    depends_on:
      - clickhouse
    dns:
      - 8.8.8.8
      - 1.1.1.1
    networks:
      - gdelt-net
    # OPTIMISATION : Grafana est trÃ¨s lÃ©ger
    deploy:
      resources:
        limits:
          memory: 512M
networks:
  gdelt-net:
    driver: bridge
